# ECG 渲染技术规范 ("黄金配置")

**版本**: 1.2 (ActiveNotch可选 / 性能模式独立)
**日期**: 2026-02-02
**目的**: 定义实现高保真、流畅且临床准确的 ECG 波形所需的具体信号处理和渲染流水线。

---

## 1. 后端处理 (Python/Scipy)
**目标**: 在不改变生理信号特征的前提下消除环境噪声。

### A. ActiveNotch™ 仿真 (谐波滤波)
*   **对象**: 由于非线性负载，电源线干扰通常包含谐波。
*   **策略**: **可配置**。用户可选 "Standard" 或 "Enhanced ActiveNotch™"。
    *   **Standard (默认)**: 仅对 **50Hz** (基频) 进行单次滤波。最纯净，无谐波处理。
    *   **Enhanced (增强)**: 级联陷波 (Cascade Notch)。处理 **50+100+150Hz**，且每级运行两次 (Double Cascade)。
*   **频率**: 50Hz (基频) [可选: +100/150Hz]。
*   **触发逻辑**: 界面勾选 **"增强" (Enhanced)** 复选框时激活谐波级联。
*   **Q值**: 35 (双级级联后有效 Q 值约为 70)。
*   **收益**: Enhanced 模式消除在高倍缩放时可见的“微锯齿”噪声。
*   **关于信号损伤的工程论证**:
    *   **疑问**: 去除 100Hz/150Hz 是否会损伤 QRS 波群细节？
    *   **解答**: 理论上有微小损伤，但工程上可忽略。
    *   **理由 1 (手术刀效应)**: 陷波器 Q=35 意味着带宽极窄 (<1Hz)。它只切除 `99.3-100.7Hz` 和 `149-151Hz` 的极窄频带，保留了 99% 的频谱能量。
    *   **理由 2 (信噪比权衡)**: 工频谐波造成的“锯齿纹理”对视觉干扰极大，而 QRS 波群在 100Hz 处的能量占比较小。**以 <0.1% 的信号能量损失换取 100% 的视觉纯净度**，是符合临床工程学的最优解。

### B. 低通滤波器 (LowPass Filter)
*   **类型**: **Causal** (因果积分，IIR)。
*   **阶数**: **1阶** (-6dB/oct)。
*   **截止频率**: **40Hz** (体表 ECG 标准 / Workmate 默认值)。
*   **理由**:
    *   **为何用 1 阶?**: 优先保证 **相位线性度** 和 **无预振铃 (No Pre-ringing)**。它的滚降缓慢，能完美保留 QRS 波群的锐利起始点。
    *   **代价**: 相比高阶滤波，它会漏过更多的高频噪声 (如肌电/毛刺)。这部分均交由前端“微平滑”主要处理。

### C. 高通滤波器 (HighPass Filter)
*   **频率**: **0.5Hz** (或用户自定义)。
*   **用途**: 校正基线漂移 (Baseline Wander)。
*   **位置**: 在低通滤波之后执行，确保去噪后的信号基准稳定。

---

## 2. 前端预处理 (JavaScript)
**目标**: 对信号进行显示级打磨，补偿后端 1 阶滤波器较缓滚降带来的残留噪声。

### A. 微平滑 (Micro-Smoothing)
*   **算法**: 3点加权移动平均。
*   **状态**: **默认开启** (UI可切换)。
*   **核权重**: `[0.1, 0.8, 0.1]`
*   **逻辑**: `y[i] = 0.1*y[i-1] + 0.8*y[i] + 0.1*y[i+1]`
*   **理由**:
    *   后端的 1 阶滤波器会残留高频毛刺。
    *   标准平滑 (`0.15, 0.7`) 会损伤 aVL 导联的细节。
    *   **Micro** 核 (`0.1, 0.8`) 是“黄金分割点”：有效抑制“毛刺” (高频噪点) 而不侵蚀 I/III/aVL 导联的锐利波峰 (真实信号)。

### B. 降采样 (LTTB)
*   **算法**: Largest-Triangle-Three-Buckets (最大三角形三桶法)。
*   **目标点数**: **4000** 点/通道。
*   **理由**:
    *   **视觉无损**: 在标准 1920x1080 分辨率下，4000 点 > 2倍像素宽度。
    *   **高速完整性**: 在 100mm/s 极速下，该密度确保我们实际上是在渲染原始数据，防止任何“多边形”折线感。

---

## 3. 混合降采样架构 (Hybrid Downsampling)
**目标**: 解决海量数据传输与高保真渲染之间的矛盾。
**策略**: **Backend Min-Max** -> **Frontend LTTB**。

### A. 第一级：后端压缩 (Python)
*   **算法**: **Min-Max** (最小最大值法)。
*   **输入**: 原始高频信号 (如 2000Hz, 1小时数据)。
*   **输出**: 传输数据 (JSON)。
*   **逻辑**: 将数据每 N 个点分为一组，每组保留一个 `Min` 和一个 `Max`。
*   **理由**:
    *   **绝对保真**: 确保传输给前端的数据包含 100% 的极值 (R波尖峰)，物理上不丢失任何幅度信息。
    *   **压缩率**: 在保留所有峰值的前提下大幅减小 JSON 体积。

### B. 第二级：前端渲染 (JavaScript)
*   **算法**: **可切换**。
    *   **LTTB (默认)**: Largest-Triangle-Three-Buckets。视觉最佳，波形圆润自然。
    *   **Min-Max**: 峰值保留。波形更“毛糙”，但确保屏幕上每一像素列都绘制出了该时段内的真实最大/最小值。
*   **输入**: 后端传输过来的 Min-Max 数据。
*   **输出**: 屏幕绘制点 (Traces)。
*   **参数**: 4000 点/通道。
*   **理由**:
    *   **LTTB**: 适合大多数临床观察，形状更符合传统心电图纸的质感。
    *   **Min-Max**: 适合科研测量，确保 QRS 波幅度的绝对显示精度。

---

## 4. 渲染引擎 (Plotly/SVG)
**目标**: 绘制出最自然、抗锯齿的线条。

### A. 引擎类型
### A. 引擎类型 (可切换)
*   **选项**: **Quality (SVG)** vs **Performance (WebGL)**。
*   **SVG (默认)**:
    *   类型: `scatter`
    *   线条: `spline` (样条插值)
    *   优点: 完美的抗锯齿，圆润的波形。
    *   缺点: 性能开销大。
*   **WebGL**:
    *   类型: `scattergl`
    *   线条: `linear` (折线，不支持 spline)
    *   优点: 极高性能，适合低配设备。
    *   缺点: 抗锯齿较弱，线条锐利。

### B. 插值 (Spline)
*   **形状**: `spline` (样条曲线)。
*   **平滑度**: **0.3**。
*   **理由**:
    *   **0.3** 是“紧致贴合 (Tight Fit)”。
    *   **1.0+** (默认): 太圆，会磨平锐利的 R 波和切迹。
    *   **0.0** (线性): 太尖，看起来像数字折线/有锯齿。
    *   **0.3**: 既消除了像素级的阶梯感，又紧紧贴合数据点。

---

## 参数摘要

| 组件 | 参数 | 数值 | 备注 |
| :--- | :--- | :--- | :--- |
| **后端 Notch** | 模式 | `Standard` / `Enhanced` | 增强模式含谐波 |
| **后端 LP** | 阶数 | `1` | Causal，缓滚降 |
| **后端 LP** | 频率 | `40 Hz` | 标准值 |
| **前端平滑** | 权重核 | `[0.1, 0.8, 0.1]` | 可开关 |
| **LTTB** | 点数 | `4000` | 高密度 |
| **前端算法** | 算法 | `LTTB` / `Min-Max` | 视觉/峰值切换 |
| **渲染** | 引擎 | `SVG` / `WebGL` | 画质/性能切换 |
| **Spline** | 系数 | `0.3` (SVG only) | WebGL 为线性 |

---

# 📚 工程开发日志 (Engineering Journal)

记录达成“黄金配置”的全过程迭代历史。

### 第一阶段：WebGL 锯齿时代 (起点)
*   **状态**: Plotly `scattergl` (WebGL), 默认 LTTB (1000点), 后端 LP 40Hz (1阶)。
*   **问题**: 用户反馈严重的“锯齿感”，尤其在 100mm/s 高速下。
*   **分析**: WebGL 缺乏对细线的高质量抗锯齿支持。1000点不足以覆盖高速渲染。

### 第二阶段：过度平滑尝试
*   **动作**: 
    1. 切换到 `scatter` (SVG) 以获得原生抗锯齿。
    2. LTTB 增至 1500 点。
    3. 启用高斯预平滑 `[0.15, 0.7, 0.15]`。
    4. 启用 Spline 插值 (Smooth=1.3)。
*   **结果**: 视觉上非常平滑（奶油般顺滑）。
*   **反馈**: **驳回**。“高频损伤严重”。I/III/aVL 导联的锐利切迹被抹平。因为高斯模糊 + 强样条系数删除了诊断细节。

### 第三阶段：后端重拳出击
*   **动作**:
    1. 前端：彻底移除高斯预平滑。
    2. 后端：LowPass 升级为 **2阶** (-12dB/oct) 以物理杀灭噪声。
    3. 前端：Spline 降至 1.0。
*   **结果**: 基线非常干净。
*   **反馈**: **驳回**。波形看起来“肉肉的”或“模糊”，失去了体表 ECG 特有的清脆起始感。2阶滤波器的相位失真/锐度损失被感知到了。

### 第四阶段：高保真回转 (权衡)
*   **动作**:
    1. 后端：LowPass 恢复为 **1阶** (-6dB/oct) 以保真。
    2. LTTB 增至 **4000点** (近乎无损)。
    3. Spline 降至 **0.3** (紧贴)。
*   **结果**: 极其锐利、精准的波形。
*   **反馈**: **喜忧参半**。“高频变得太高了” (波形毛糙)。裸奔的 1阶滤波器漏过了太多的肌电噪声和台阶感。

### 第五阶段：黄金平衡 (最终解)
*   **诊断**: 我们需要第四阶段的锐度，加上第二阶段的干净，但不要第二阶段的信号损失。
*   **动作**:
    1. **保留后端 1 阶** (尊重物理)。
    2. **保留 LTTB 4000** (保留数据)。
    3. **保留 Spline 0.3** (保留几何特征)。
    4. **新增 "微平滑"**: 极柔和的高斯核 `[0.1, 0.8, 0.1]`。
*   **结果**: 微平滑层充当了“视觉降噪器”，擦除了 1 阶滤波残留的毛边，同时丝毫未动 aVL 的结构化高频细节。
*   **验证**: 用户确认“就是这个味儿”。视觉质感对齐顶级电生理工作站标准。

### 第六阶段：性能与自由度 (v1.2)
*   **需求**: 低配电脑 SVG 卡顿；用户希望控制 ActiveNotch 强度。
*   **动作**:
    1.  **后端**: ActiveNotch 解耦。默认仅 50Hz (Standard)，可选增强谐波 (Enhanced)。
    2.  **前端**: 新增渲染引擎切换。SVG (画质, Spline) vs WebGL (性能, Linear)。
    3.  **前端**: 新增微平滑开关。
*   **结果**: 既保留了“黄金配置”的上限，又兼容了低端设备的下限。
