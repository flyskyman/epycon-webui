<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDF5 æ–‡ä»¶é¢„è§ˆå™¨ (h5wasm) - ä¿®å¤ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f5;
        }

        header {
            background: #333;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: normal;
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§æ–‡ä»¶æ ‘ */
        #tree-view {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
            font-size: 14px;
        }

        .tree-item {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-item:hover {
            background-color: #f0f0f0;
        }

        .tree-item.selected {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .tree-indent {
            margin-left: 20px;
        }

        .icon-group::before {
            content: "ğŸ“ ";
            color: #fbc02d;
        }

        .icon-dataset::before {
            content: "ğŸ”¢ ";
            color: #4caf50;
        }

        .icon-link::before {
            content: "ğŸ”— ";
            color: #9c27b0;
        }

        /* å³ä¾§è¯¦æƒ… */
        #detail-view {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .panel {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .panel h2 {
            margin-top: 0;
            font-size: 1.1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            color: #444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            font-family: monospace;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f9f9f9;
            width: 150px;
        }

        .array-preview {
            background: #2d2d2d;
            color: #eee;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        #loading {
            display: none;
            color: #aaa;
            font-style: italic;
            margin-left: 10px;
        }

        .error-msg {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <header>
        <h1>HDF5 Preview (Fixed)</h1>
        <input type="file" id="file-input" accept=".h5,.hdf5,.he5,.sel,.nxs" disabled>
        <span id="status">æ­£åœ¨åˆå§‹åŒ– WebAssembly...</span>
    </header>

    <div id="main-container">
        <div id="tree-view">
            <div style="color: #888; text-align: center; margin-top: 20px;">è¯·é€‰æ‹©ä¸€ä¸ª .h5 æ–‡ä»¶</div>
        </div>
        <div id="detail-view">
            <div style="color: #888; text-align: center; margin-top: 50px;">åœ¨å·¦ä¾§é€‰æ‹©èŠ‚ç‚¹ä»¥æŸ¥çœ‹è¯¦æƒ…</div>
        </div>
    </div>

    <script type="module">
        import h5wasm from "https://cdn.jsdelivr.net/npm/h5wasm@latest/dist/esm/hdf5_hl.js";

        const fileInput = document.getElementById('file-input');
        const statusSpan = document.getElementById('status');
        const treeView = document.getElementById('tree-view');
        const detailView = document.getElementById('detail-view');

        let currentFile = null;
        let Module = null; // ä¿å­˜ WASM æ¨¡å—å®ä¾‹
        let FS = null;     // ä¿å­˜æ–‡ä»¶ç³»ç»Ÿå®ä¾‹

        // 1. åˆå§‹åŒ– h5wasm
        (async () => {
            try {
                // ç­‰å¾… WASM åŠ è½½å®Œæˆï¼Œè¿”å› Module å¯¹è±¡
                Module = await h5wasm.ready;
                // [å…³é”®ä¿®å¤] FS å¿…é¡»ä» Module ä¸­è·å–ï¼Œè€Œä¸æ˜¯ä» h5wasm å¯¼å‡ºä¸­è·å–
                FS = Module.FS;

                console.log("h5wasm initialized. FS available:", !!FS);
                statusSpan.textContent = "åº“å·²å°±ç»ªï¼Œè¯·é€‰æ‹©æ–‡ä»¶";
                statusSpan.style.color = "#4caf50";
                fileInput.disabled = false;
            } catch (e) {
                console.error("Initialization failed:", e);
                statusSpan.textContent = "åˆå§‹åŒ–å¤±è´¥: " + e.message;
                statusSpan.style.color = "red";
                alert("WebAssembly åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°æ—¥å¿—ã€‚");
            }
        })();

        // 2. å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!FS) {
                alert("æ–‡ä»¶ç³»ç»Ÿæœªå°±ç»ªï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
                return;
            }

            statusSpan.textContent = `æ­£åœ¨è¯»å– ${file.name}...`;
            statusSpan.style.color = "white";

            try {
                // è¯»å–æ–‡ä»¶å†…å®¹ä¸º ArrayBuffer
                const buffer = await file.arrayBuffer();

                // å°†æ–‡ä»¶å†™å…¥ Emscripten è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (MEMFS)
                // ä½¿ç”¨ç®€å•çš„æ–‡ä»¶åä»¥é¿å…è·¯å¾„é—®é¢˜
                const fname = "input_file.h5";

                // [å…³é”®æ­¥éª¤] å†™å…¥æ–‡ä»¶
                try {
                    FS.writeFile(fname, new Uint8Array(buffer));
                } catch (fsErr) {
                    throw new Error(`å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¤±è´¥: ${fsErr.message}`);
                }

                // å¦‚æœä¹‹å‰æœ‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œå…ˆå…³é—­
                if (currentFile) {
                    try { currentFile.close(); } catch (e) { console.warn("Closing previous file error", e); }
                    currentFile = null;
                }

                // æ‰“å¼€ HDF5 æ–‡ä»¶
                try {
                    currentFile = new h5wasm.File(fname, "r");
                } catch (openErr) {
                    throw new Error(`æ— æ³•æ‰“å¼€ HDF5 æ–‡ä»¶ (å¯èƒ½æ˜¯æ ¼å¼æŸåæˆ–é HDF5 æ–‡ä»¶): ${openErr.message}`);
                }

                // æ¸²æŸ“æ ‘ç»“æ„
                renderTree(currentFile);

                statusSpan.textContent = `å·²åŠ è½½: ${file.name}`;
                detailView.innerHTML = `<div style="color: #888; text-align: center; margin-top: 50px;">æ–‡ä»¶å·²åŠ è½½ã€‚<br>ç‚¹å‡»å·¦ä¾§èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…ã€‚</div>`;

            } catch (err) {
                console.error("File processing error:", err);
                statusSpan.textContent = "è§£æé”™è¯¯";
                statusSpan.style.color = "red";
                // åœ¨è¯¦æƒ…é¡µæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
                detailView.innerHTML = `<div class="panel" style="border-color:red;">
                <h2 style="color:red">è§£æé”™è¯¯</h2>
                <p>${err.message}</p>
                <p>è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° (F12 -> Console) è·å–æ›´å¤šæŠ€æœ¯ç»†èŠ‚ã€‚</p>
            </div>`;
            }
        });

        // é€’å½’æ¸²æŸ“æ–‡ä»¶æ ‘
        function renderTree(file) {
            treeView.innerHTML = '';
            // åˆ›å»ºæ ¹èŠ‚ç‚¹
            const rootItem = createTreeItem(file, '/', 'group', 0);
            treeView.appendChild(rootItem);
            // è‡ªåŠ¨å±•å¼€æ ¹èŠ‚ç‚¹
            loadChildren(file, rootItem, 0);

            // è‡ªåŠ¨æ˜¾ç¤ºæ ¹èŠ‚ç‚¹çš„è¯¦æƒ…ï¼ˆåŒ…å«å…¨å±€å±æ€§ï¼‰
            showDetails(file, '/');
            // é«˜äº®æ ¹èŠ‚ç‚¹
            rootItem.classList.add('selected');
        }

        function createTreeItem(node, name, type, level) {
            const div = document.createElement('div');
            div.className = `tree-item icon-${type}`;
            div.style.paddingLeft = (level * 20 + 5) + 'px';
            div.textContent = name;
            div.title = node.path || name; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå…¨è·¯å¾„

            div.onclick = (e) => {
                e.stopPropagation();
                // é«˜äº®é€‰ä¸­
                document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
                div.classList.add('selected');

                // æ˜¾ç¤ºè¯¦æƒ…
                showDetails(node, name);

                // å¦‚æœæ˜¯ç»„ï¼Œä¸”æœªå±•å¼€ï¼Œåˆ™å°è¯•å±•å¼€
                if (type === 'group' && !div.dataset.expanded) {
                    loadChildren(node, div, level);
                }
            };
            return div;
        }

        // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åœ°åºåˆ—åŒ–å€¼ï¼ˆå¤„ç† BigIntã€TypedArray ç­‰ï¼‰
        function safeStringify(val) {
            try {
                // å¤„ç† BigInt
                if (typeof val === 'bigint') {
                    return val.toString();
                }
                // å¤„ç† TypedArray
                if (val && val.length !== undefined && typeof val !== 'string' && !Array.isArray(val)) {
                    val = Array.from(val);
                }
                // å¤„ç†æ•°ç»„ä¸­å¯èƒ½åŒ…å«çš„ BigInt
                if (Array.isArray(val)) {
                    val = val.map(v => typeof v === 'bigint' ? v.toString() : v);
                }
                return JSON.stringify(val);
            } catch (e) {
                // å¦‚æœä»ç„¶å¤±è´¥ï¼Œè¿”å›å­—ç¬¦ä¸²è¡¨ç¤º
                return String(val);
            }
        }

        function loadChildren(groupNode, parentElement, level) {
            if (parentElement.dataset.expanded) return;

            try {
                // è·å–ç»„ä¸‹çš„æ‰€æœ‰ key
                const keys = groupNode.keys();
                keys.sort();

                // åˆ›å»ºå­å®¹å™¨
                const container = document.createElement('div');
                parentElement.after(container);

                if (keys.length === 0) {
                    // ç©ºç»„æç¤º
                    // const empty = document.createElement('div');
                    // empty.textContent = "(empty)";
                    // empty.style.paddingLeft = ((level + 1) * 20 + 20) + 'px';
                    // empty.style.color = "#ccc";
                    // container.appendChild(empty);
                }

                for (const key of keys) {
                    try {
                        const child = groupNode.get(key);
                        // åˆ¤æ–­ç±»å‹
                        let type = 'unknown';
                        if (child instanceof h5wasm.Group) type = 'group';
                        else if (child instanceof h5wasm.Dataset) type = 'dataset';
                        else if (child instanceof h5wasm.ExternalLink) type = 'link';
                        else if (child instanceof h5wasm.SoftLink) type = 'link';

                        const item = createTreeItem(child, key, type, level + 1);
                        container.appendChild(item);
                    } catch (e) {
                        console.warn(`Skipping child ${key}`, e);
                    }
                }
                parentElement.dataset.expanded = "true";
            } catch (e) {
                console.error("Error loading keys for group", e);
            }
        }

        function showDetails(node, name) {
            let html = `<h1>${name}</h1>`;

            // 1. åŸºæœ¬ä¿¡æ¯
            html += `<div class="panel"><h2>åŸºæœ¬ä¿¡æ¯ (Metadata)</h2><table>`;
            // å°è¯•è·å– pathï¼Œå¦‚æœæ²¡æœ‰ï¼ˆå¦‚æ ¹èŠ‚ç‚¹å¯èƒ½ï¼‰åˆ™æ˜¾ç¤º name
            html += `<tr><th>è·¯å¾„ (Path)</th><td>${node.path || '/'}</td></tr>`;

            if (node instanceof h5wasm.Dataset) {
                html += `<tr><th>ç±»å‹ (Type)</th><td>Dataset</td></tr>`;
                html += `<tr><th>æ•°æ®ç±»å‹ (Dtype)</th><td>${node.dtype}</td></tr>`;
                // å¤„ç† shape
                const shapeStr = Array.isArray(node.shape) ? `[${node.shape.join(', ')}]` : String(node.shape);
                html += `<tr><th>å½¢çŠ¶ (Shape)</th><td>${shapeStr}</td></tr>`;

                // å…¶ä»–å…ƒæ•°æ®
                if (node.metadata) {
                    for (let [k, v] of Object.entries(node.metadata)) {
                        if (!['shape', 'type', 'dtype'].includes(k)) {
                            html += `<tr><th>${k}</th><td>${v}</td></tr>`;
                        }
                    }
                }
            } else if (node instanceof h5wasm.Group) {
                html += `<tr><th>ç±»å‹ (Type)</th><td>Group</td></tr>`;
                try {
                    html += `<tr><th>æˆå‘˜æ•°é‡</th><td>${node.keys().length}</td></tr>`;
                } catch (e) { }
            }
            html += `</table></div>`;

            // 2. å±æ€§ (Attributes) - å¢å¼ºç‰ˆ
            try {
                const attrs = node.attrs;
                const attrKeys = Object.keys(attrs);

                // å¯¹äºæ ¹èŠ‚ç‚¹ï¼Œç‰¹åˆ«æ ‡æ³¨è¿™æ˜¯å…¨å±€å±æ€§
                const isRoot = (node.path === '/' || name === '/');
                const panelTitle = isRoot ? 'ğŸ“‹ å…¨å±€å±æ€§ (File-level Attributes)' : 'å±æ€§ (Attributes)';

                if (attrKeys.length > 0) {
                    html += `<div class="panel"><h2>${panelTitle}</h2>`;

                    // å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œä¼˜å…ˆæ˜¾ç¤ºé‡è¦çš„ metadata
                    if (isRoot) {
                        const importantKeys = ['subject_id', 'subject_name', 'study_id', 'datetime', 'timestamp',
                            'merged', 'num_files', 'num_channels', 'sampling_freq',
                            'author', 'device', 'owner'];
                        const otherKeys = attrKeys.filter(k => !importantKeys.includes(k));
                        const orderedKeys = [...importantKeys.filter(k => attrKeys.includes(k)), ...otherKeys];

                        html += `<table><tr><th style="width: 200px;">Key</th><th>Value</th></tr>`;
                        for (let key of orderedKeys) {
                            let val = attrs[key].value;
                            // é«˜äº®é‡è¦å­—æ®µ
                            const isImportant = ['subject_id', 'subject_name', 'study_id'].includes(key);
                            const keyStyle = isImportant ? 'font-weight: bold; color: #1976d2;' : '';
                            html += `<tr><td style="${keyStyle}">${key}</td><td>${safeStringify(val)}</td></tr>`;
                        }
                        html += `</table>`;
                    } else {
                        // éæ ¹èŠ‚ç‚¹ï¼Œæ­£å¸¸æ˜¾ç¤º
                        html += `<table><tr><th>Key</th><th>Value</th></tr>`;
                        for (let key of attrKeys) {
                            let val = attrs[key].value;
                            html += `<tr><td>${key}</td><td>${safeStringify(val)}</td></tr>`;
                        }
                        html += `</table>`;
                    }
                    html += `</div>`;
                } else if (isRoot) {
                    // æ ¹èŠ‚ç‚¹ä½†æ²¡æœ‰å±æ€§ï¼Œæ˜¾ç¤ºè­¦å‘Š
                    html += `<div class="panel"><h2>ğŸ“‹ å…¨å±€å±æ€§ (File-level Attributes)</h2>`;
                    html += `<div style="color: #ff9800; padding: 10px;">âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶çº§å±æ€§ã€‚è¿™å¯èƒ½æ„å‘³ç€æ–‡ä»¶æœªæ­£ç¡®å†™å…¥ metadataã€‚</div>`;
                    html += `</div>`;
                }
            } catch (e) {
                console.error("Error reading attributes:", e);
                html += `<div class="panel"><h2>å±æ€§ (Attributes)</h2>`;
                html += `<div class="error-msg">è¯»å–å±æ€§å¤±è´¥: ${e.message}</div></div>`;
            }

            // 3. æ•°æ®é¢„è§ˆ (ä»…é’ˆå¯¹ Dataset)
            if (node instanceof h5wasm.Dataset) {
                html += `<div class="panel"><h2>æ•°æ®é¢„è§ˆ (Data Preview)</h2>`;

                try {
                    const shape = node.shape || [];
                    const totalSize = shape.reduce((a, b) => a * b, 1);

                    if (totalSize === 0) {
                        html += `<div>Empty Dataset</div>`;
                    } else if (totalSize > 2000) {
                        // å¤§æ•°æ®ï¼šè¯»å–åˆ‡ç‰‡
                        let sliceVal = null;
                        let sliceMsg = "";

                        if (shape.length === 1) {
                            const limit = Math.min(100, shape[0]);
                            sliceVal = node.slice([[0, limit]]);
                            sliceMsg = `å‰ ${limit} é¡¹ (å…± ${totalSize} é¡¹)`;
                        } else if (shape.length === 2) {
                            const rows = Math.min(20, shape[0]);
                            const cols = Math.min(20, shape[1]);
                            sliceVal = node.slice([[0, rows], [0, cols]]);
                            sliceMsg = `å·¦ä¸Šè§’ ${rows}x${cols} åˆ‡ç‰‡ (æ€»å½¢çŠ¶: ${shape.join('x')})`;
                        } else {
                            sliceMsg = "å¤šç»´æ•°æ®è¿‡å¤§ï¼Œæš‚ä¸æ”¯æŒåˆ‡ç‰‡é¢„è§ˆã€‚";
                        }

                        if (sliceVal) {
                            html += `<div><strong>${sliceMsg}</strong></div>`;
                            html += `<div class="array-preview">${formatArray(sliceVal)}</div>`;
                        } else {
                            html += `<div>${sliceMsg}</div>`;
                        }
                    } else {
                        // å°æ•°æ®ï¼šè¯»å–å…¨éƒ¨
                        const val = node.value;
                        html += `<div class="array-preview">${formatArray(val)}</div>`;
                    }
                } catch (e) {
                    html += `<div class="error-msg">è¯»å–æ•°æ®å†…å®¹å¤±è´¥: ${e.message}</div>`;
                    console.error(e);
                }
                html += `</div>`;
            }

            detailView.innerHTML = html;
        }

        function formatArray(data) {
            if (data === null || data === undefined) return "null";

            // å°è¯•å°†å…¶è½¬æ¢ä¸ºæ™®é€šæ•°ç»„
            let arr;
            if (Array.isArray(data)) {
                arr = data;
            } else if (data.buffer && data.length !== undefined) {
                // TypedArray
                arr = Array.from(data);
            } else {
                return String(data);
            }

            // è½¬æ¢æ•°ç»„ä¸­çš„ BigInt ä¸ºå­—ç¬¦ä¸²
            arr = arr.map(item => typeof item === 'bigint' ? Number(item) : item);

            // å¦‚æœæ•°ç»„è¿˜æ˜¯å¤ªå¤§ï¼Œå†æ¬¡æˆªæ–­æ˜¾ç¤ºå­—ç¬¦ä¸²
            if (arr.length > 500) {
                const head = arr.slice(0, 100);
                try {
                    return JSON.stringify(head, null, 2).replace(/\]$/, `,\n  "... (${arr.length - 100} more items)"\n]`);
                } catch (e) {
                    return `[Array with ${arr.length} items - serialization failed: ${e.message}]`;
                }
            }

            try {
                return JSON.stringify(arr, null, 2);
            } catch (e) {
                return `[Array - serialization failed: ${e.message}]`;
            }
        }
    </script>

</body>

</html>