<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>H5 å¤„ç†é€Ÿåº¦å¯¹æ¯”æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        h1 {
            color: #333;
        }

        .test-section {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .result {
            font-family: monospace;
            background: #1a1a2e;
            color: #4ade80;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            white-space: pre-wrap;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: block;
            margin: 15px 0;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison>div {
            background: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .comparison h3 {
            margin: 0 0 10px 0;
        }

        .time {
            font-size: 32px;
            font-weight: bold;
            color: #059669;
        }
    </style>
</head>

<body>
    <h1>âš¡ H5 å¤„ç†é€Ÿåº¦å¯¹æ¯”æµ‹è¯•</h1>

    <div class="test-section">
        <h2>é€‰æ‹© HDF5 æ–‡ä»¶</h2>
        <input type="file" id="file-input" accept=".h5,.hdf5" />
        <button id="btn-test" disabled>ğŸš€ å¼€å§‹æµ‹è¯•</button>
        <span id="status">æ­£åœ¨åˆå§‹åŒ– h5wasm...</span>
    </div>

    <div class="comparison" id="comparison" style="display:none;">
        <div>
            <h3>ğŸ–¥ï¸ åç«¯ Python h5py</h3>
            <div class="time" id="time-backend">-</div>
            <p>é€šè¿‡ API ä¸Šä¼ å¤„ç†</p>
        </div>
        <div>
            <h3>ğŸŒ å‰ç«¯ h5wasm</h3>
            <div class="time" id="time-frontend">-</div>
            <p>æµè§ˆå™¨ç›´æ¥è¯»å–</p>
        </div>
    </div>

    <div class="result" id="result">ç­‰å¾…æµ‹è¯•...</div>

    <script type="module">
        import h5wasm from "https://cdn.jsdelivr.net/npm/h5wasm@latest/dist/esm/hdf5_hl.js";

        const fileInput = document.getElementById('file-input');
        const btnTest = document.getElementById('btn-test');
        const statusSpan = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const comparisonDiv = document.getElementById('comparison');

        let Module = null;
        let FS = null;
        let selectedFile = null;

        // åˆå§‹åŒ– h5wasm
        (async () => {
            try {
                Module = await h5wasm.ready;
                FS = Module.FS;
                statusSpan.textContent = "âœ… h5wasm å°±ç»ª";
                statusSpan.style.color = "#059669";
            } catch (e) {
                statusSpan.textContent = "âŒ åˆå§‹åŒ–å¤±è´¥: " + e.message;
                statusSpan.style.color = "red";
            }
        })();

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                btnTest.disabled = false;
                resultDiv.textContent = `å·²é€‰æ‹©: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(1)} MB)`;
            }
        });

        btnTest.addEventListener('click', async () => {
            if (!selectedFile || !FS) return;

            btnTest.disabled = true;
            resultDiv.textContent = "ğŸ”„ æ­£åœ¨æµ‹è¯•...\n";
            comparisonDiv.style.display = "grid";

            let log = "";
            const addLog = (msg) => {
                log += msg + "\n";
                resultDiv.textContent = log;
            };

            // ========== æµ‹è¯• 1: åç«¯ API ==========
            addLog("ğŸ“¤ æµ‹è¯•åç«¯ API (ä¸Šä¼  + Python å¤„ç†)...");
            const formData = new FormData();
            formData.append('file', selectedFile);

            let backendTime = 0;
            try {
                const startBackend = performance.now();
                const response = await fetch('/api/ecg/upload', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');
                const result = await response.json();

                // ä¹Ÿæµ‹è¯•è¯»å–æ•°æ®
                const dataResp = await fetch(`/api/ecg/data/${result.file_id}?start=0&end=10`);
                await dataResp.json();

                backendTime = performance.now() - startBackend;
                addLog(`âœ… åç«¯å®Œæˆ: ${backendTime.toFixed(0)} ms`);
                document.getElementById('time-backend').textContent = `${backendTime.toFixed(0)} ms`;
            } catch (e) {
                addLog(`âŒ åç«¯é”™è¯¯: ${e.message}`);
                document.getElementById('time-backend').textContent = "é”™è¯¯";
            }

            // ========== æµ‹è¯• 2: å‰ç«¯ h5wasm ==========
            addLog("\nğŸ“‚ æµ‹è¯•å‰ç«¯ h5wasm (æœ¬åœ°è¯»å–)...");
            let frontendTime = 0;
            try {
                const startFrontend = performance.now();

                // Step 1: è¯»å–æ–‡ä»¶
                const buffer = await selectedFile.arrayBuffer();
                addLog(`   è¯»å– ArrayBuffer: ${(performance.now() - startFrontend).toFixed(0)} ms`);

                // Step 2: å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                const fname = "test.h5";
                FS.writeFile(fname, new Uint8Array(buffer));
                addLog(`   å†™å…¥ MEMFS: ${(performance.now() - startFrontend).toFixed(0)} ms`);

                // Step 3: æ‰“å¼€ HDF5
                const h5file = new h5wasm.File(fname, "r");
                addLog(`   æ‰“å¼€ HDF5: ${(performance.now() - startFrontend).toFixed(0)} ms`);

                // Step 4: è¯»å–å…ƒæ•°æ®
                const attrs = h5file.attrs;
                const fs = attrs['Fs'] ? attrs['Fs'].value[0] : 2000;

                // Step 5: è¯»å–æ•°æ®
                if (h5file.get('Data')) {
                    const dataNode = h5file.get('Data');
                    const shape = dataNode.shape;
                    addLog(`   æ•°æ®å½¢çŠ¶: [${shape.join(', ')}]`);

                    // è¯»å–å‰ 10 ç§’æ•°æ®
                    const samples = Math.min(Math.floor(fs * 10), shape[0]);
                    const channels = Math.min(12, shape[1]);
                    const sliceData = dataNode.slice([[0, samples], [0, channels]]);
                    addLog(`   è¯»å–åˆ‡ç‰‡ [${samples} x ${channels}]: ${(performance.now() - startFrontend).toFixed(0)} ms`);
                }

                h5file.close();
                FS.unlink(fname);

                frontendTime = performance.now() - startFrontend;
                addLog(`\nâœ… å‰ç«¯å®Œæˆ: ${frontendTime.toFixed(0)} ms`);
                document.getElementById('time-frontend').textContent = `${frontendTime.toFixed(0)} ms`;
            } catch (e) {
                addLog(`âŒ å‰ç«¯é”™è¯¯: ${e.message}`);
                console.error(e);
                document.getElementById('time-frontend').textContent = "é”™è¯¯";
            }

            // å¯¹æ¯”ç»“æœ
            addLog("\n" + "=".repeat(50));
            if (backendTime > 0 && frontendTime > 0) {
                const ratio = backendTime / frontendTime;
                if (ratio > 1) {
                    addLog(`ğŸ† å‰ç«¯å¿« ${ratio.toFixed(1)}x`);
                } else {
                    addLog(`ğŸ† åç«¯å¿« ${(1 / ratio).toFixed(1)}x`);
                }
            }

            btnTest.disabled = false;
        });
    </script>
</body>

</html>